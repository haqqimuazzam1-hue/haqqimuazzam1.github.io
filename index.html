<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HMM AI - Asisten Pribadi Terpintar</title>
    <meta name="description" content="HMM AI adalah asisten pribadi berbasis Gemini 2.5 Flash yang bisa bikin gambar anti-peyot, video animasi, dan punya ingatan permanen.">
    <meta name="keywords" content="HMM AI, AI Terpintar, AI Indonesia, AI Video Generator, AI Image Generator">
    <meta name="author" content="Haqqi Muazzam Mulhim">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f001a; 
            --accent: #c084fc; 
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(192, 132, 252, 0.2);
            --danger: #ff4d4d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg);
            color: #f1f1f1;
            font-family: 'Space Grotesk', sans-serif;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #orion-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }

        header {
            padding: 15px 25px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); z-index: 10;
        }
        .brand { font-weight: 700; font-size: 20px; color: var(--accent); letter-spacing: 2px; }
        
        .clear-btn {
            background: none; color: var(--accent); border: 1px solid var(--border);
            padding: 6px 14px; border-radius: 20px; font-size: 11px; cursor: pointer;
        }

        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-card { background: #1a0033; border: 1px solid var(--border); padding: 30px; border-radius: 24px; text-align: center; max-width: 320px; }

        #chat-flow {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column;
            gap: 25px; z-index: 5; max-width: 900px; margin: 0 auto; width: 100%;
        }

        .bubble { max-width: 85%; line-height: 1.7; animation: slideIn 0.3s ease; font-size: 15px; word-wrap: break-word; }
        .user { align-self: flex-end; background: var(--glass); padding: 12px 18px; border-radius: 18px 18px 0 18px; border: 1px solid var(--border); }
        .ai { align-self: flex-start; width: 100%; border-left: 2px solid var(--accent); padding-left: 15px; }
        
        .footer { padding: 20px; z-index: 10; background: linear-gradient(transparent, var(--bg) 60%); }
        .input-wrap {
            max-width: 800px; margin: 0 auto; background: rgba(255, 255, 255, 0.02);
            border-radius: 20px; border: 1px solid var(--border); padding: 8px 12px;
            display: flex; align-items: center; gap: 8px; backdrop-filter: blur(20px);
        }
        textarea { flex: 1; background: none; border: none; color: white; padding: 10px; resize: none; outline: none; font-size: 16px; font-family: inherit; }
        
        .btn-tool { color: var(--accent); background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; }
        .btn-send { background: var(--accent); color: #000; padding: 10px 18px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; }

        pre { background: #000 !important; padding: 12px; border-radius: 10px; margin: 10px 0; overflow-x: auto; border: 1px solid var(--border); position: relative; }
        .copy-tag { position: absolute; top: 8px; right: 8px; background: var(--accent); color: #000; border: none; padding: 3px 6px; border-radius: 4px; font-size: 9px; cursor: pointer; font-weight: bold; }
        
        .gen-img-wrap { margin-top: 10px; width: 100%; }
        .gen-image { width: 100%; border-radius: 15px; border: 1px solid var(--border); }
        .dl-btn {
            display: inline-flex; align-items: center; gap: 5px; background: var(--accent); color: #000;
            padding: 8px 14px; border-radius: 8px; border: none; font-size: 11px; font-weight: bold;
            margin-top: 8px; cursor: pointer;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<canvas id="orion-canvas"></canvas>

<div id="modal-overlay">
    <div class="modal-card">
        <h3 style="color:var(--accent); margin-bottom:10px;">HAPUS CHAT?</h3>
        <p style="font-size:14px; color:#ccc; margin-bottom:20px;">Hapus semua riwayat percakapan?</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="btn-send" style="background:var(--glass); color:white; border:1px solid var(--border);" onclick="closeModal()">TIDAK</button>
            <button class="btn-send" style="background:var(--danger); color:white;" onclick="confirmWipe()">HAPUS</button>
        </div>
    </div>
</div>

<header>
    <div class="brand">HMM AI</div>
    <button class="clear-btn" onclick="openModal()">HAPUS CHAT</button>
</header>

<div id="chat-flow"></div>

<div class="footer">
    <div class="input-wrap">
        <label class="btn-tool">
            <svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            <input type="file" id="f-in" hidden onchange="handleImg(this)">
        </label>
        <textarea id="t-in" placeholder="Tulis Perintah..." rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
        <button class="btn-tool" onclick="startVoice()">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
        </button>
        <button class="btn-send" onclick="execute()">KIRIM</button>
    </div>
</div>

<script>
    // --- API CONFIG & VAULT ---
    const _VAULT = [
        "QUl6YVN5QnJ1Qko1R051cjdURU hVOW1ZJSzJrQkpMQUVQWFV6VHM=",
        "QUl6YVN5QmFiRTVUWU9FcUlHMjJzZGRlSUlOSEQzQ19keTJvV1ZRPQ==",
        "QUl6YVN5Q0M1U2Iyc1FZWnM4WEFYQjlUVUs5ZFBnSjhJS3M2MWU0",
        "QUl6YVN5QnU1RWszZU5mbjBVc3hJYTNCYVA5V0VIMlBYS0ZKQjNN"
    ];
    let keyIndex = 0;
    const _M = "gemini-2.5-flash";

    // --- STAR ENGINE ---
    const canvas = document.getElementById('orion-canvas');
    const ctx = canvas.getContext('2d');
    let pts = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();
    class Pt {
        constructor() { this.reset(); }
        reset() { this.x = Math.random()*canvas.width; this.y = Math.random()*canvas.height; this.vX = (Math.random()-0.5)*0.5; this.vY = (Math.random()-0.5)*0.5; this.s = Math.random()*2; }
        update() { this.x+=this.vX; this.y+=this.vY; if(this.x<0||this.x>canvas.width||this.y<0||this.y>canvas.height) this.reset(); }
        draw() { ctx.fillStyle = 'rgba(192, 132, 252, 0.3)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.s, 0, Math.PI*2); ctx.fill(); }
    }
    for(let i=0; i<70; i++) pts.push(new Pt());
    function anim() { ctx.clearRect(0,0,canvas.width,canvas.height); pts.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(anim); }
    anim();

    // --- OTAK PERMANEN ---
    let chatHistory = JSON.parse(localStorage.getItem('hmm_data')) || [];
    let userName = localStorage.getItem('hmm_user_name') || "";

    function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    // --- FITUR DIRECT DOWNLOAD (BLOB CONVERSION) ---
    async function directDownload(url, filename) {
        const btn = event.currentTarget;
        const originalText = btn.innerText;
        btn.innerText = "SABAR...";
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(blobUrl);
            document.body.removeChild(a);
            btn.innerText = "DONE!";
        } catch (error) {
            btn.innerText = "ERROR!";
            window.open(url, '_blank');
        } finally {
            setTimeout(() => btn.innerText = originalText, 2000);
        }
    }

    function print(txt, role) {
        const flow = document.getElementById('chat-flow');
        const div = document.createElement('div');
        div.className = `bubble ${role}`;
        div.innerHTML = txt;
        flow.appendChild(div);
        flow.scrollTop = flow.scrollHeight;
        return div;
    }

    function typeEffect(text, element) {
        let i = 0; element.innerHTML = "";
        const interval = setInterval(() => {
            if (i < text.length) {
                element.innerText = text.substring(0, i + 1); i++;
                document.getElementById('chat-flow').scrollTop = document.getElementById('chat-flow').scrollHeight;
            } else {
                clearInterval(interval);
                element.innerHTML = marked.parse(text); 
                hljs.highlightAll();
                addCopyBtns();
            }
        }, 12);
    }

    window.onload = () => {
        if (chatHistory.length > 0) {
            chatHistory.forEach(item => {
                const bubble = print("", item.role);
                bubble.innerHTML = (item.type === "image" || item.type === "video") ? item.text : marked.parse(item.text);
            });
        }
        if (!userName) {
            typeEffect("Halo! Saya HMM AI. Siapa nama Boss?", print("", "ai"));
        } else {
            typeEffect(`Selamat datang kembali, Boss ${userName}!`, print("", "ai"));
        }
    };

    let b64 = "";
    function handleImg(i) {
        if(i.files[0]) {
            const r = new FileReader();
            r.onload = e => { b64 = e.target.result.split(',')[1]; alert("Visual siap!"); };
            r.readAsDataURL(i.files[0]);
        }
    }

    function startVoice() {
        const r = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        r.lang = 'id-ID'; r.start();
        r.onresult = e => { document.getElementById('t-in').value = e.results[0][0].transcript; };
    }

    async function execute() {
        const tin = document.getElementById('t-in');
        const val = tin.value.trim();
        if(!val && !b64) return;

        const curB64 = b64;
        print(marked.parse(val || "Visual Input"), "user");
        tin.value = ""; b64 = ""; tin.style.height = 'auto';

        if (!userName && chatHistory.length === 0) {
            userName = val;
            localStorage.setItem('hmm_user_name', userName);
            typeEffect(`Siap Boss ${userName}! Ada yang bisa dibantu?`, print("", "ai"));
            return;
        }

        const aiBubble = print("...", "ai");
        const lowerVal = (val || "").toLowerCase();

        if (lowerVal.includes("video") || ["gambar", "lukis", "visual", "foto"].some(k => lowerVal.includes(k))) {
            const isVideo = lowerVal.includes("video");
            const seed = Math.floor(Math.random() * 999999);
            const promptAsli = val.replace(/video|gambar|lukis|visual|foto|buatkan/gi, "").trim();
            const booster = ", highly detailed, masterpiece, 8k" + (isVideo ? ", animation" : "");
            const urlMedia = `https://image.pollinations.ai/prompt/${encodeURIComponent(promptAsli + booster)}?width=1024&height=1024&seed=${seed}&model=flux&nologo=true`;
            const fileName = `HMM_AI_${seed}.${isVideo ? 'mp4' : 'jpg'}`;

            let resHTML = `Beres Boss ${userName}!<br><div class="gen-img-wrap"><img src="${urlMedia}" class="gen-image"><button class="dl-btn" onclick="directDownload('${urlMedia}', '${fileName}')">DOWNLOAD ${isVideo ? 'VIDEO' : 'IMAGE'}</button></div>`;

            aiBubble.innerHTML = resHTML;
            chatHistory.push({ role: "ai", text: resHTML, type: isVideo ? "video" : "image" });
            localStorage.setItem('hmm_data', JSON.stringify(chatHistory));
        } else {
            chatHistory.push({ role: "user", text: val, type: "text" });
            let success = false; let retryCount = 0;
            while (!success && retryCount < _VAULT.length) {
                try {
                    const currentKey = atob(_VAULT[keyIndex % _VAULT.length].replace(/\s/g, ''));
                    const contents = chatHistory.slice(-10).map(msg => ({
                        role: msg.role === "user" ? "user" : "model",
                        parts: [{ text: msg.text }]
                    }));
                    if (curB64) contents[contents.length-1].parts.push({ inline_data: { mime_type: "image/jpeg", data: curB64 } });

                    const systemPrompt = `Nama kamu HMM AI. Asisten Boss ${userName}. Santai & cerdas.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${_M}:generateContent?key=${currentKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: systemPrompt }] } })
                    });
                    const data = await res.json();
                    const reply = data.candidates[0].content.parts[0].text;
                    typeEffect(reply, aiBubble);
                    chatHistory.push({ role: "ai", text: reply, type: "text" });
                    localStorage.setItem('hmm_data', JSON.stringify(chatHistory));
                    success = true;
                } catch(e) { keyIndex++; retryCount++; }
            }
        }
    }

    function confirmWipe() { localStorage.clear(); location.reload(); }
    function addCopyBtns() {
        document.querySelectorAll('pre').forEach(p => {
            if (p.querySelector('.copy-tag')) return;
            const b = document.createElement('button'); b.className = 'copy-tag'; b.innerText = 'COPY';
            b.onclick = () => { navigator.clipboard.writeText(p.innerText.replace('COPY','').trim()); b.innerText = 'DONE'; setTimeout(()=>b.innerText='COPY', 2000); };
            p.appendChild(b);
        });
    }
</script>
</body>
</html>